# 生字練習選字邏輯

最後更新：2026-02
相關程式碼：`frontend/src/components/reading-steps/LiveTutor.tsx`（`extractPracticeChars`）
　　　　　　`frontend/src/components/reading-steps/VocabPractice.tsx`（`displayChars`）

---

## 目的

逐段朗讀結束後，系統要決定「哪些字值得讓學生練習筆順？」。

選得太寬（把整段都標記）→ 學生覺得莫名其妙，失去信心。
選得太窄（完全不選）→ 白白錯過練習機會。
選錯字（和錯誤無關）→ 學生失去對系統的信任。

這份文件說明目前的選字邏輯、每個決策背後的理由，以及已知的限制。

---

## 資料來源

每次學生完成一段朗讀後，系統儲存一筆 `LineResult`：

```typescript
interface LineResult {
  lineIndex: number;    // 第幾段（0-based）
  matchRate: number;    // 0–1，字元級別命中率（同音字修正後）
  cpm: number;          // 每分鐘字數（流暢度）
  durationMs: number;   // 這段朗讀花了多少毫秒
  transcript: string;   // STT 原始輸出（cleanChineseText 處理後）
}
```

全部段落完成（或學生手動按完成）時，`lineResults[]` 傳入 `extractPracticeChars`，計算出 `mispronouncedWords: string[]`，存入 `ReadingAttempt`，再傳給 `VocabPractice`。

---

## 五步驟管線

### 步驟一：去重，只保留每段最後一次嘗試

學生若 Tier 3 重試，同一個 `lineIndex` 可能有多筆 `LineResult`。

```
第一次嘗試：matchRate 0.4（Tier 3 →重試）
第二次嘗試：matchRate 0.6（Tier 2 →過關）
```

只保留**最後一筆**（Tier 2 那次）。理由：學生最後讀對了，就不應因為前面的失誤被懲罰。

```typescript
const lastByLine = new Map<number, LineResult>();
for (const r of results) {
  lastByLine.set(r.lineIndex, r); // 後進覆蓋先進
}
```

---

### 步驟二：文字正規化

對「課文原文」和「學生說的話」各自做同一套正規化：

| 步驟 | 操作 | 例子 |
|------|------|------|
| cleanChineseText | 移除中文字間空格（STT 常插空格） | `'古 時候 有'` → `'古時候有'` |
| normalizeNumbers | 阿拉伯數字→中文數字 | `'4000公尺'` → `'四千公尺'` |
| 移除標點 | 去掉 `「」，。！？：；、` 等 | `'農夫，他'` → `'農夫他'` |

正規化讓比對不被標點、空白影響，且 STT 永遠不會輸出中文標點，所以兩邊去掉標點才能對齊。

---

### 步驟三：同音字修正（Levenshtein 對齊）

這是最關鍵的一步。`correctHomophones` 使用 Levenshtein 編輯距離對齊 STT 輸出與課文原文：

```
STT：農夫他每天都去田裡看禾苗長高了
課文：農夫他每天都去田裡看禾苗長高了
（上面例子完全一致）

STT：農夫他每天都去田力看禾苗長高了
課文：農夫他每天都去田裡看禾苗長高了
               ↑ STT 說了「力」
```

對每一對對齊的（STT字, 課文字）：

| 情況 | 處理 | 說明 |
|------|------|------|
| 完全相同 | 保留 STT 字 | 正確朗讀 |
| 同音字（聲母韻母相同，不分聲調） | 替換成課文字 | STT 拼音誤辨，不算錯 |
| 非同音字 | 保留 STT 字 | 真正的錯誤 |
| 課文有、STT 沒有（插入） | **跳過** | 學生漏唸了這個字 |
| STT 有、課文沒有（刪除） | 保留 STT 字 | 學生多說了什麼 |

修正後的字串代表「學生實際說出的字（同音字視為正確）」。

**同音字判斷**：使用約 2500 個常用字的無聲調拼音表。聲調不同但聲母韻母相同的字（如「禾/河/和/何/合」都是 `he`）視為同音字，不扣分。這對台灣 STT 尤其重要，因為聲調辨識常不穩定。

---

### 步驟四：字元頻率比對，找出「課文有、spokenFreq 沒有」的字

對正規化後的「學生發音」建立字元頻率表，再掃課文原文：

```typescript
// 學生說的字（同音字修正後）的頻率表
const spokenFreq: Record<string, number> = {};
for (const ch of spokenNorm) { ... }

// 逐一對照課文原文的每個字
for (const ch of targetNorm) {
  if (spokenFreq[ch] > 0) {
    spokenFreq[ch]--;  // 對到了，消耗一次
  } else {
    chars.add(ch);     // 課文有這個字，spokenFreq 裡沒有 → 標記
  }
}
```

這個比對會捕捉到**兩種性質不同的情況**，但以相同的方式處理：

#### 漏字（Omission）

學生完全沒說這個字。在 Levenshtein 對齊中屬於「insertion」——課文有，STT 沒有，直接跳過，不進入 corrected output，自然不在 spokenFreq。

```
課文：農夫他每天都去田裡
STT：農夫他每天都去裡      ← 「田」直接跳過
corrected output：農夫他每天都去裡
spokenFreq：無「田」→ 標記 ✓
```

#### 錯字（Substitution）

學生說了一個不相干的字（非同音字）。在 Levenshtein 對齊中屬於「genuine mismatch substitution」——`correctHomophones` 保留 STT 字（錯字），不放課文字，因此課文字不進 spokenFreq。

```
課文：農夫他每天都去田裡
STT：農夫他每天都去廚裡      ← 「廚」（chú）≠「田」（tián），非同音
correctHomophones 對齊：廚 aligned with 田 → keep 廚（genuine mismatch）
corrected output：農夫他每天都去廚裡
spokenFreq：有「廚」，無「田」→ 標記 ✓
```

**兩種情況的最終結果相同**：目標字不在 spokenFreq → 被標記為練習字。這是一個「副作用式的捕捉」，而非明確針對錯字設計的邏輯。

**目前的限制**：系統知道「田這個字需要練習」，但不知道「學生是跳過了田，還是把田說成了廚」。這兩種情況在教學上應有不同的回應（見第六節）。

**頻率比對的重要性**：
若課文出現「農農農夫」（農字3次），學生只說了「農夫」（農字1次），則「農」會被標記（說了1次，需要3次）。若課文只出現1次，學生說了1次，就不會標記。

---

### 步驟五：過濾 + 上限

```typescript
return Array.from(chars).slice(0, 12);
```

- **上限 12 個字**：研究顯示一次看太多字會讓兒童喪失學習動機。12 個是一次練習的合理上限。
- 後續在 `VocabPractice` 中再過濾掉沒有筆順資料的字（`hasStrokeData(ch)` → false 的字從顯示清單移除，但不影響 `mispronouncedWords` 原始資料）。

---

## VocabPractice 的顯示邏輯

`mispronouncedWords` 傳入 VocabPractice 後，決定顯示什麼：

```
有漏字 → 只顯示漏字（最多12個）
         說明文字：「朗讀時漏掉了以下 N 個字，點一點來練習筆順吧！」

沒有漏字（全對） → 顯示課文中的漢字（選讀，非強制）
                    說明文字：「讀得很棒！沒有漏字。想再練習這篇的字嗎？」
```

**為什麼有漏字時不混入其他課文字？**
若「漏字3個 + 其他9個課文字」混在一起，學生看到12個字，只有3個有意義，剩下9個莫名其妙，會失去對系統的信任。每張卡都要有明確的意義。

---

## 已知限制

### 1. 字元頻率比對 vs. 位置比對

目前用「字元頻率」而非「位置對齊」來找漏字。

例子：課文「禾苗長高」，學生說「高禾苗長」（順序完全顛倒）→ 頻率比對認為完全正確（每個字都有說到）。
這表示：**只要字說了，不管順序，不會被標記漏字**。
對閱讀流暢度評估而言這是不足，但對「是否認識這個字」的判斷仍有參考價值。

### 2. 同音字表的覆蓋範圍

僅收錄約 2500 個常用字，且多音字只取最常見讀音（`charToPinyin` 第一次映射優先）。罕見字或多音字的特殊讀音不在表內，可能造成應修正卻沒修正的情況。

### 3. 跳過的段落不計入

若學生按「下一段」跳過某段（未做 STT），該段不會有 `LineResult`，自然不會被分析。系統只能評估學生實際朗讀過的段落。

### 4. STT 品質的影響

STT 誤辨嚴重時（背景噪音、麥克風問題），`transcript` 可能有大量非預期字元。同音字修正能處理部分情況，但若整句都辨識錯誤，後果就是漏字數量被過度高估。

---

## 未來改進方向

| 方向 | 說明 | 複雜度 |
|------|------|--------|
| **區分漏字與錯字** | 記錄每個被標記字的原因（漏字 or 錯字），給出不同回饋 | 中（需改 LineResult 結構） |
| **錯字顯示對比** | 顯示「你把『田』說成了『廚』」，幫助學生理解混淆 | 中 |
| **多次標記加權** | 若同一個字在多段都被標記，排序優先顯示 | 低 |
| **老師自訂生字表** | 老師可為每篇課文指定重點字，不依賴 STT | 中 |
| **跨課程追蹤** | 記錄哪些字跨多篇課文都被標記，做間隔複習 | 高（需後端） |
| **聲調分析** | 目前不分聲調，未來可加入聲調辨識評分 | 高（需 STT 信心值） |

---

## 小結：選字的核心原則

> **每個被標記為「建議練習」的字，都是課文裡有、但在學生最後一次嘗試的 spokenFreq 裡找不到的字（同音字除外）。**
> 這涵蓋了兩種情況：學生跳過了這個字（漏字），或學生說了別的字（錯字）。
> 目前兩者以相同方式處理；未來可以區分並給出更精確的教學回應。

不多選、不亂選。選到的字有明確的依據，可以向學生解釋。
